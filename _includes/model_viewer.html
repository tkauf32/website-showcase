<div class="viewer-3d">
  <canvas id="glbCanvas-{{ include.src | slugify }}"></canvas>
</div>

<script type="module">
  // Use CDN ESM modules (no bundler needed)
  import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
  import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";
  import { GLTFLoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js";
  import { DRACOLoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/DRACOLoader.js";
  import { RGBELoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/RGBELoader.js";

  const src = "{{ include.src | relative_url }}";
  const canvas = document.getElementById("glbCanvas-{{ include.src | slugify }}");

  const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, 1, 0.01, 100);
  camera.position.set(1.2, 0.9, 1.6);

  const controls = new OrbitControls(camera, canvas);
  controls.enableDamping = true;

  // Lighting (simple, no HDR to avoid CORS)
  scene.add(new THREE.HemisphereLight(0xffffff, 0x222233, 0.9));
  const dir = new THREE.DirectionalLight(0xffffff, 0.7);
  new RGBELoader()
    .load("{{ '/assets/env/studio_small_03_1k.hdr' | relative_url }}", (hdr) => {
      hdr.mapping = THREE.EquirectangularReflectionMapping;
      scene.environment = hdr;
    });
  dir.position.set(3, 5, 2);
  scene.add(dir);

  // GLTF + DRACO
  const loader = new GLTFLoader();
  const draco = new DRACOLoader();
  // Point to Draco decoder files hosted on unpkg (draco_decoder.wasm / .js)
  draco.setDecoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/");
  loader.setDRACOLoader(draco);

  loader.load(
    src,
    (gltf) => {
      const root = gltf.scene || gltf.scenes?.[0];
      if (!root) throw new Error("GLB loaded but no scene found");
      scene.add(root);

      // Auto-center & fit
      const box = new THREE.Box3().setFromObject(root);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());
      root.position.sub(center);

      const length = size.length();
      camera.near = length / 100;
      camera.far = length * 10;
      camera.updateProjectionMatrix();
      camera.position.set(length * 0.6, length * 0.45, length * 0.9);
    },
    undefined,
    (err) => {
      console.error("GLB load error:", err);
      const msg = document.createElement("div");
      msg.textContent = "Failed to load 3D model.";
      msg.style.cssText = "padding:8px;color:#b00;font:14px/1.4 system-ui;";
      canvas.parentElement.appendChild(msg);
    }
  );

  function resize() {
    const rect = canvas.getBoundingClientRect();
    const w = rect.width, h = rect.height || 420;
    renderer.setSize(w, h, false);
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
  }
  function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
  new ResizeObserver(resize).observe(canvas.parentElement);
  resize(); animate();
</script>
